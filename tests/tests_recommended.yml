- name: Ensure that the recommended profile is set correctly
  hosts: all

  roles:
    - name: tuned
      use_recommended_profile: true

  tasks:
    - name: Get active profile
      command: tuned-adm active
      register: active
      changed_when: false

    - name: Set active_profile string
      set_fact:
        active_profile: "{{ active.stdout_lines[0] | regex_replace('^.*\\: (.*)$', '\\1') }}"

    - name: Get recommended profile
      command: tuned-adm recommend
      register: recommend
      ignore_errors: yes
      changed_when: false

    # legacy tuned doesn't have the notion of a recommended profile, but should use 'default'
    - name: Set recommended profile string
      set_fact:
        recommended_profile: "{{ recommend.stdout if recommend.rc == 0 else 'default' }}"

    - name: Assert that active_profile is the recommended_profile
      assert:
        that: "{{ active_profile == recommended_profile }}"
